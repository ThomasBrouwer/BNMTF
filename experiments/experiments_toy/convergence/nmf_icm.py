"""
Recover the toy dataset using ICM.

We can plot the MSE, R2 and Rp as it converges, on the entire dataset.

We have I=100, J=80, K=10, and no test data.
We give flatter priors (1/10) than what was used to generate the data (1).
"""

project_location = "/Users/thomasbrouwer/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.models.nmf_icm import nmf_icm

import numpy, matplotlib.pyplot as plt

##########

input_folder = project_location+"BNMTF/data_toy/bnmf/"

iterations = 200
init_UV = 'random'
I, J, K = 100,80,10

minimum_TN = 0.1

alpha, beta = 1., 1. #1., 1.
lambdaU = numpy.ones((I,K))/10.
lambdaV = numpy.ones((J,K))/10.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaU':lambdaU, 'lambdaV':lambdaV }

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
M = numpy.ones((I,J))

# Run the VB algorithm
NMF = nmf_icm(R,M,K,priors) 
NMF.initialise(init_UV)
NMF.run(iterations,minimum_TN=minimum_TN)

# Plot the tau values to check convergence
plt.plot(NMF.all_tau)

# Extract the performances across all iterations
print "icm_all_performances = %s" % NMF.all_performances

'''
icm_all_performances = {'R^2': [-3.011325221921278, 0.6122247892013752, 0.6466573083285352, 0.7009971539050444, 0.7516170229311595, 0.7907776368331421, 0.8234330007573292, 0.8439394309755051, 0.863190988228737, 0.875907208593979, 0.8863902136389366, 0.8956711204838093, 0.9030691260197806, 0.9093572010424538, 0.915006474554024, 0.9208683743857938, 0.9297717022302099, 0.9382762694219999, 0.9440805949318114, 0.9481637834640294, 0.9512339963214808, 0.9536824976757972, 0.9557067102933176, 0.9574117113766332, 0.9588800821133757, 0.9601711935524039, 0.9613289552855884, 0.9623773397863895, 0.9633363247611982, 0.9642260298165124, 0.9650591336929771, 0.9658476771519857, 0.9665981939045396, 0.9673144124559565, 0.9679974803398015, 0.9686491553083643, 0.969270689248866, 0.9698621475376464, 0.9704231637295726, 0.9709522041051154, 0.9714462525541149, 0.9719082527778845, 0.9723401535497302, 0.9727429011312829, 0.9731153722352602, 0.9734587356715676, 0.973774679558256, 0.9740650713542474, 0.974331384589147, 0.9745760048935016, 0.9748003226577837, 0.9750056187155984, 0.9751933204372832, 0.9753656793342897, 0.975524450646072, 0.9756705826874299, 0.9758048782658982, 0.9759279983494072, 0.9760414435441985, 0.9761464198666829, 0.9762439737494745, 0.9763349709416392, 0.9764200978273005, 0.9765000143023518, 0.9765752982876535, 0.9766464029077505, 0.9767137870977944, 0.976777763158665, 0.9768385275485062, 0.976896216756862, 0.9769508565927314, 0.9770027176525754, 0.9770520143237956, 0.9770989747053823, 0.9771437967041209, 0.9771867068689287, 0.9772279068848454, 0.9772675330411751, 0.9773057059437851, 0.977342545050111, 0.9773781524421333, 0.9774125855589668, 0.9774458879203755, 0.9774780881680812, 0.9775092418374954, 0.9775394190363488, 0.9775686807741273, 0.9775970857638983, 0.9776246782141919, 0.9776514555564746, 0.9776773801685651, 0.9777025450581172, 0.977726974765106, 0.9777507057351827, 0.977773769986438, 0.9777961961130616, 0.9778180098685153, 0.9778391179450548, 0.9778594233471256, 0.9778791331558111, 0.9778982737730811, 0.9779168751767531, 0.9779349635705069, 0.9779525633727618, 0.9779697029026608, 0.9779863975071169, 0.9780026731155237, 0.9780185484716732, 0.9780340431606896, 0.978049172458006, 0.9780639490962261, 0.9780783664143862, 0.9780924240341047, 0.9781061480430513, 0.9781195515938678, 0.9781326453125075, 0.9781454390967911, 0.9781579418980331, 0.9781701632363203, 0.9781820969824855, 0.9781937497906589, 0.9782051380898764, 0.978216273617541, 0.97822716702872, 0.9782378275386251, 0.9782482636447294, 0.9782584834847775, 0.9782684969305622, 0.9782783083736516, 0.9782879238019593, 0.9782973496940097, 0.9783065918326681, 0.9783156553899555, 0.9783245452786685, 0.9783332660090225, 0.9783418221871046, 0.9783502214956838, 0.9783584688467293, 0.9783665679674812, 0.9783745221792527, 0.9783823342804722, 0.9783900075324913, 0.9783975455379338, 0.9784049516509242, 0.9784122290694917, 0.9784193810552732, 0.9784264109568401, 0.9784333215540182, 0.9784401168331144, 0.9784467972138723, 0.9784533657094477, 0.9784598251188316, 0.9784661780178132, 0.9784724286406051, 0.9784785765210536, 0.9784846246945589, 0.978490574938382, 0.9784964292070676, 0.9785021897245386, 0.9785078585313441, 0.9785134375766608, 0.9785189319154892, 0.9785243441381586, 0.9785296707472255, 0.9785349069305831, 0.9785400576798384, 0.9785451209562008, 0.9785501068063127, 0.9785550178068111, 0.9785598562371592, 0.9785646239133954, 0.9785693226602352, 0.9785739542582257, 0.9785785205438549, 0.9785830231596911, 0.978587463615462, 0.9785918433520977, 0.9785961637047367, 0.978600426176705, 0.9786046321511963, 0.9786087828566364, 0.9786128794436941, 0.9786169229892924, 0.978620914517937, 0.9786248550197832, 0.9786287454611107, 0.9786325867887052, 0.9786363799307498, 0.9786401256273268, 0.9786438249257021, 0.9786474789102443, 0.9786510881686012, 0.9786546542740576, 0.9786581782334028, 0.9786616608794534, 0.9786651029885662, 0.9786685052959115, 0.9786718685109778, 0.978675193270265, 0.9786784797118755], 'MSE': [157.73430399888665, 15.248190959207893, 13.894227084683257, 11.757462487642595, 9.7669757114233438, 8.2270925465674658, 6.9430104002824189, 6.1366515739550778, 5.3796371669360417, 4.8796068632731462, 4.4673915944769593, 4.1024455228758825, 3.8115393535582398, 3.5642781412850848, 3.3421360370804134, 3.1116329891045242, 2.7615341706047785, 2.4271155152741462, 2.1988764187606522, 2.0383162882317287, 1.9175886330538321, 1.8213080685030361, 1.7417114886432217, 1.674667022209924, 1.6169273916991174, 1.5661579943171295, 1.5206322064347553, 1.4794073766320301, 1.441697936689287, 1.4067127385564253, 1.373953225716426, 1.3429459284272729, 1.3134339265191106, 1.2852706068008652, 1.2584108456791596, 1.2327855243918189, 1.208345415925679, 1.1850879495364341, 1.1630275346685524, 1.142224480613619, 1.1227973875874049, 1.1046305026523751, 1.0876471956715863, 1.0718102575155173, 1.0571638583593252, 1.0436620379762187, 1.0312384157784562, 1.0198195590930468, 1.0093475254311981, 0.99972850644951539, 0.99090782887636197, 0.98283512746183466, 0.97545427480308333, 0.96867673642031549, 0.96243349236169251, 0.95668725276248079, 0.95140644942993569, 0.94656509162268587, 0.94210417213786168, 0.93797626770544396, 0.93414023024819359, 0.9305620165711973, 0.92721463651135805, 0.92407214148219363, 0.92111180633934875, 0.91831581320949329, 0.91566611573320567, 0.91315043353948344, 0.91076104145351322, 0.90849257240031112, 0.90634401151215838, 0.9043047183293389, 0.90236626265840725, 0.90051967513550812, 0.89875717362198382, 0.89706984970632575, 0.89544977268044479, 0.89389158334325391, 0.89239053920155542, 0.89094194292108075, 0.8895417804094069, 0.88818779303172968, 0.88687826949332238, 0.88561208353744347, 0.88438705138716822, 0.88320041624929679, 0.88204977909400717, 0.88093283119181676, 0.879847834164179, 0.87879488901158076, 0.87777547512257825, 0.87678593522762871, 0.87582530435987571, 0.87489214939457238, 0.87398521130859863, 0.87310336571426961, 0.87224559992771622, 0.87141558301871114, 0.87061712906998723, 0.86984209518892353, 0.8690894431908508, 0.86835799428075899, 0.86764671807118854, 0.86695465437512453, 0.8662806896203562, 0.86562422033184516, 0.8649842269076814, 0.86435997229992823, 0.86375068637758001, 0.86315576847634679, 0.86257471792169738, 0.86200779663765459, 0.86145501950304237, 0.86091536069217323, 0.86038830301368052, 0.85987342863123994, 0.85937034834035375, 0.85887871015525485, 0.85839813972478196, 0.8579288780615355, 0.85747066351018941, 0.85702285004420875, 0.85658497612258366, 0.85615662276416882, 0.85573742760618043, 0.85532705650891405, 0.85492518947799712, 0.85453143833240564, 0.85414563038582314, 0.85376753018006835, 0.8533968829650258, 0.85303346134546332, 0.85267706194591431, 0.85232749158420296, 0.85198457290854068, 0.85164812479725416, 0.85131784514663356, 0.85099354080704281, 0.85067506521502889, 0.85036228776911549, 0.85005509842882376, 0.8497533689504887, 0.8494569576708636, 0.84916573269825701, 0.84887956827898092, 0.8485983361581636, 0.84832190466246238, 0.84805016448289794, 0.84778295886893829, 0.8475202713153247, 0.84726198333801117, 0.84700798487439988, 0.84675817463867775, 0.84651238613211321, 0.84627063768491595, 0.84603280993833896, 0.84579883300649417, 0.84556863003229732, 0.84534211356611799, 0.84511920336899038, 0.84489982279490938, 0.84468377306992015, 0.84447095233647151, 0.84426149812187212, 0.84405559964896826, 0.84385306063656762, 0.84365396125449776, 0.84345790644623908, 0.84326479489265405, 0.84307453696012746, 0.84288706123796631, 0.8427022959742555, 0.84252017115390265, 0.84234061456207177, 0.84216356160928918, 0.84198895292968789, 0.84181673186265349, 0.84164684590755723, 0.84147923595023777, 0.8413138476004226, 0.84115063255365174, 0.8409895455630545, 0.84083054428159665, 0.84067358842341477, 0.84051863905338364, 0.8403656581752259, 0.84021460855919117, 0.84006545370704999, 0.83991816451709866, 0.83977269980849656, 0.83962901694143854, 0.83948709280829625, 0.83934686554397742, 0.83920829555927523, 0.839071350105973, 0.83893599865597379, 0.83880221230074248, 0.83866996314159414, 0.83853922614992127, 0.83840999589523302], 'Rp': [1.6650962751468002e-15, 0.7882267556563668, 0.81082005528312073, 0.84464755790440516, 0.87567154425592608, 0.89567605777854831, 0.911986474659361, 0.92304281921242981, 0.93245470293748689, 0.93857273971410227, 0.94411945168132871, 0.94835723957754248, 0.95195145202385845, 0.95508993701257561, 0.95790030948654403, 0.96112138648840095, 0.9655802028904521, 0.96976645853939103, 0.97255329793700007, 0.97450727939084725, 0.97599219525555536, 0.97717828980609389, 0.97815684773681111, 0.97897956277920639, 0.97968676041250824, 0.98030924782559825, 0.98086951941481348, 0.98137679317533166, 0.98184100134932395, 0.98227194231377801, 0.98267497979445817, 0.98305735022283247, 0.98342179300312593, 0.98376909949134639, 0.9841001154676412, 0.98441616710411484, 0.9847182706846539, 0.98500512484919034, 0.98527698390593077, 0.98553408169324486, 0.98577449886363677, 0.98599917346746624, 0.98620932631755143, 0.98640550554917072, 0.9865868263181865, 0.9867536070100219, 0.98690681008646364, 0.98704761771464311, 0.98717649401586283, 0.98729477309369285, 0.98740323712604328, 0.98750289398249202, 0.98759388723536434, 0.9876777408145121, 0.98775516856171364, 0.98782635223676929, 0.98789172050533436, 0.98795168375928677, 0.98800700316719514, 0.98805814337109588, 0.9881055964379204, 0.98814992588862671, 0.98819142608497657, 0.98823040016646768, 0.98826719659451212, 0.98830201978397603, 0.98833499476344389, 0.98836627741257366, 0.98839598124796169, 0.98842416526715737, 0.98845086882148236, 0.98847619957360466, 0.98850027249993688, 0.98852321409437904, 0.98854514246087655, 0.98856613598959342, 0.9885862900991409, 0.98860570614489096, 0.98862437069829079, 0.98864237583615411, 0.98865978949058841, 0.98867666989755565, 0.98869300426966844, 0.9887088025123586, 0.98872408501692555, 0.98873888627440343, 0.98875323786819735, 0.98876716833191103, 0.98878070763457426, 0.98879385628954841, 0.98880659388404946, 0.9888189381784126, 0.98883091673148737, 0.98884254993184817, 0.9888538545464316, 0.98886484435794753, 0.98887553158327124, 0.98888588614974082, 0.98889585916406963, 0.98890551656138648, 0.98891488565733354, 0.98892398781654889, 0.98893283506035368, 0.98894144940568662, 0.9889498420376277, 0.98895801680383988, 0.98896598275884429, 0.98897376288288286, 0.98898135704831713, 0.98898876886754861, 0.98899600495164453, 0.98900306515083236, 0.98900994598910519, 0.98901666055021531, 0.98902321701864448, 0.98902962089292512, 0.98903587709749796, 0.98904199029598217, 0.98904796555866281, 0.98905380683161292, 0.98905950874391446, 0.98906507915584196, 0.98907052519077776, 0.98907585069839266, 0.989081061329811, 0.98908616169840469, 0.98909115619310806, 0.98909605100892106, 0.98910084784303032, 0.98910554868545331, 0.9891101563168726, 0.98911467358897287, 0.98911910312636953, 0.98912344735955438, 0.98912770868844768, 0.98913189183769146, 0.98913599967536969, 0.98914003338198853, 0.98914399398336661, 0.98914788290824585, 0.98915170287281684, 0.98915545495386625, 0.98915914071032474, 0.98916276166326567, 0.98916631935387, 0.98916981549582716, 0.98917325157574698, 0.98917662884985613, 0.9891799512710493, 0.98918321660701081, 0.98918642658930078, 0.98918958320466677, 0.98919268791997528, 0.98919574438331481, 0.98919874928050555, 0.98920170497979909, 0.98920461252591718, 0.98920747295473088, 0.98921028736744432, 0.9892130567333659, 0.9892157819823445, 0.98921846634463872, 0.98922111229721765, 0.98922371515115415, 0.98922627523133499, 0.98922879624153026, 0.98923127856514548, 0.98923372177022806, 0.98923612780812831, 0.98923849797795116, 0.98924083352487735, 0.98924313552631349, 0.98924540519104887, 0.98924764297266665, 0.98924984937654337, 0.98925202506649701, 0.98925417065134291, 0.98925628688189982, 0.98925837456179899, 0.98926043422646315, 0.98926246637546478, 0.98926447159299391, 0.98926645045616168, 0.98926840351631695, 0.98927033129934649, 0.9892722343101118, 0.98927411303670243, 0.98927596795333295, 0.98927779952148565, 0.98927960946775573, 0.98928139939093485, 0.98928316617733236, 0.98928491243112571, 0.9892866382350306, 0.98928834382235475, 0.98929002950129463, 0.98929169564596531, 0.98929334257207657, 0.98929497053647408, 0.98929658161386502]}
'''